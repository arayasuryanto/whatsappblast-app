<!DOCTYPE html>
<html>
<head>
    <title>Firebase Connection Test</title>
</head>
<body>
    <h1>Firebase Connection Test</h1>
    <div id="status">Testing...</div>
    <div id="results"></div>
    
    <button onclick="testWrite()">Test Write Activity</button>
    <button onclick="testCampaign()">Test Save Campaign</button>
    
    <script src="database-service.js"></script>
    <script>
        let testResults = [];
        
        async function runTests() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            
            statusEl.innerHTML = 'Initializing Firebase...';
            testResults.push('üîÑ Starting Firebase initialization...');
            updateResults();
            
            try {
                // First test: Basic Firebase connection
                console.log('Testing Firebase connection...');
                const isOnline = await window.databaseService.initialize();
                
                if (isOnline) {
                    statusEl.innerHTML = '‚úÖ Firebase Connected Successfully!';
                    testResults.push('‚úÖ Firebase initialization: SUCCESS');
                    testResults.push(`‚úÖ Database available: ${!!window.databaseService.db}`);
                    testResults.push(`‚úÖ Auth available: ${!!window.databaseService.auth}`);
                    testResults.push(`‚úÖ Current user: ${window.databaseService.currentUser?.name || 'None'}`);
                    testResults.push(`‚úÖ Team ID: ${window.databaseService.teamId || 'None'}`);
                    
                    updateResults();
                    
                    // Wait a bit for auth to settle
                    setTimeout(async () => {
                        try {
                            // Test activity logging
                            testResults.push('üîÑ Testing activity logging...');
                            updateResults();
                            
                            await window.databaseService.logActivity('test_activity', {
                                message: 'Test activity from connection test',
                                timestamp: Date.now(),
                                browser: navigator.userAgent.split(')')[0] + ')'
                            });
                            testResults.push('‚úÖ Activity logging: SUCCESS');
                            updateResults();
                            
                            // Test getting activities
                            testResults.push('üîÑ Testing activity retrieval...');
                            updateResults();
                            
                            window.databaseService.getActivities((activities) => {
                                testResults.push(`‚úÖ Activity retrieval: SUCCESS (${activities.length} activities)`);
                                if (activities.length > 0) {
                                    testResults.push(`   Latest activity: ${activities[0].type} by ${activities[0].userName}`);
                                }
                                updateResults();
                            });
                            
                        } catch (error) {
                            testResults.push('‚ùå Test error: ' + error.message);
                            updateResults();
                        }
                    }, 2000);
                    
                } else {
                    statusEl.innerHTML = '‚ùå Firebase Connection Failed';
                    testResults.push('‚ùå Firebase initialization: FAILED');
                }
                
                updateResults();
                
            } catch (error) {
                console.error('Test error:', error);
                statusEl.innerHTML = '‚ùå Error: ' + error.message;
                testResults.push('‚ùå Error: ' + error.message);
                testResults.push('‚ùå Stack: ' + error.stack);
                updateResults();
            }
        }
        
        function updateResults() {
            document.getElementById('results').innerHTML = 
                '<h3>Test Results:</h3>' + 
                testResults.map(r => '<div>' + r + '</div>').join('');
        }
        
        async function testWrite() {
            try {
                await window.databaseService.logActivity('manual_test', {
                    message: 'Manual test button clicked',
                    timestamp: Date.now()
                });
                alert('Activity logged successfully!');
            } catch (error) {
                alert('Error logging activity: ' + error.message);
            }
        }
        
        async function testCampaign() {
            try {
                const campaignId = await window.databaseService.saveCampaign({
                    name: 'Test Campaign',
                    status: 'ongoing',
                    contacts: [{name: 'Test', phone: '123456789'}],
                    message: 'Test message',
                    progress: 50,
                    results: {sent: 1, failed: 0, total: 1}
                });
                alert('Campaign saved with ID: ' + campaignId);
            } catch (error) {
                alert('Error saving campaign: ' + error.message);
            }
        }
        
        // Run tests on load
        runTests();
    </script>
</body>
</html>